# Serverless 部署指引

本项目已预置对 Serverless 环境（特别是 AWS Lambda）的支持。以下是详细的部署步骤。

## 1. 核心原理
项目通过以下方式适配 Serverless：
- **`serverless-http`**: 将 Koa 实例包装成标准的 Lambda Handler。
- **专用构建入口**: `app/server/serverless.ts` 是针对 Lambda 环境优化的服务端入口。
- **两阶段打包**: 分别生成用于 SSR 的服务端 JS 和用于 CDN 的客户端静态资源。

## 2. 部署流程

### 2.1 基础设施架构 (S3 + CloudFront + Lambda)
项目采用“动静分离”架构：
- **静态资源 (S3/OSS)**: 部署 `build/client/` 目录。
- **计算逻辑 (Lambda/FC)**: 部署 `build/serverless.js`。
- **内容分发 (CloudFront/CDN)**: 挂载在最前端，根据路径 (`/static` -> S3, `/*` -> Lambda) 进行请求转发。

### 2.2 构建生产环境产物
在本地运行及产物说明：

```bash
npm run build:online
```

- `build/serverless.js`: 核心 Handler 文件（部署至 Lambda）。
- `build/client/`: 静态资源文件（上传至 S3 目录下，如 `/static/client/`）。
- `build/loadable-stats.json`: 服务端渲染所需的资源映射表（需同 Handler 一起部署）。

## 3. 缓存机制说明 (CloudFront)
- **被动缓存 (Pull Model)**: 资源仅在首位用户访问后才会同步至边缘节点，实现“按需加速”。
- **缓存刷新 (Invalidation)**: 每次更新静态资源（特别是非 Hash 命名的文件）后，建议手动创建 Invalidation 以确保用户获取最新代码。

### 第三步：正式部署
确保已安装 [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html) 并配置好 AWS 凭证。

```bash
# 1. 编译（SAM 会根据 template.yaml 打包 ./ 目录）
sam build

# 2. 部署（首次部署建议使用 --guided）
sam deploy --guided
```

## 3. 常见问题
- **静态资源加载失败**：请确保 Webpack 中的 `publicPath` 与 CDN 或 API Gateway 的路径匹配。
- **超时 (Timeout)**：SSR 是 CPU 密集型操作，建议 Lambda 内存配置不低于 2048MB（模板默认 4096MB）。
