# Node.js 进程管理指南 (PROCESS_MANAGEMENT.md)

本项目针对开发环境和生产环境采用了不同的进程管理策略，以平衡开发效率与运行稳定性。

---

## 1. 架构概览

| 环境 | 管理工具 | 核心目标 | 配置文件 | 运行端口 |
| :--- | :--- | :--- | :--- | :--- |
| **开发环境 (Dev)** | **Nodemon** | 热更新、快速迭代 | `nodemon.json` | `3001` |
| **生产环境 (Prod)** | **PM2** | 高可用、高性能集群、守护进程 | `ecosystem.config.js` | `3009` |

---

## 2. 开发环境：Nodemon

Nodemon 负责在代码发生变更时自动重启 Node 服务器。

### 配置说明 (`nodemon.json`)
*   **监视目标**：监听 `build/server.js`。即使是 SSR 架构，我们也只在 Webpack 完成服务端代码构建后才触发重启。
*   **环境变量**：注入 `NODE_ENV=development` 和 `PORT=3001`。
*   **优点**：日志直接输出在控制台，方便调试。

### 启动命令
```bash
npm run dev
```

---

## 3. 生产环境：PM2

PM2 是一个功能强大的进程管理器，确保 SSR 应用在服务器上稳定运行。

### 核心特性
1.  **集群模式 (Cluster Mode)**：
    *   通过 `exec_mode: "cluster"` 开启。
    *   利用 Node 原生的 `cluster` 模块，将请求分发到多个 CPU 核心。
    *   **重要性**：SSR 渲染属于 CPU 密集型操作，集群模式能避免单个渲染请求阻塞整个服务器。
2.  **守护进程 (Daemon)**：
    *   应用在后台运行，即使关闭 SSH 窗口也不会停止。
    *   如果应用因 OOM (内存溢出) 或报错崩溃，PM2 会立即将其拉起。
3.  **日志管理**：
    *   自动将日志输出到 `logs/` 目录，并按错误类型（error/out）分类。

### 常用操作
*   **启动服务**：`pm2 start ecosystem.config.js`
*   **查看状态**：`pm2 list` 或 `pm2 status`
*   **监控视图**：`pm2 monit` (查看各进程实时 CPU/内存占用)
*   **查看日志**：`pm2 logs [name]`
*   **重启服务**：`pm2 restart react-custom-ssr`

---

## 4. 关键差异总结

### 状态管理
*   **Nodemon**：单进程模式。主线程挂了，整个服务在重启前不可用。
*   **PM2 (Cluster)**：多进程模式。一个进程挂了，其他进程继续处理请求，用户几乎无感知。

### 资源利用
*   **Nodemon**：只利用 1 个 CPU 核心。
*   **PM2**：可配置 `instances: "max"` 榨干所有核心性能。

### 自动启动
*   **PM2** 通过 `pm2 startup` 配合系统 `systemd`，可以实现服务器断电重启后自动恢复 Node 应用。

---

## 5. 注意事项
1.  **端口冲突**：若修改了端口，需同步更新 Nginx 或 CloudFront 的反向代理设置。
2.  **状态共享**：由于生产环境开启了集群，**禁止**在 Node 内存中存储 Session、验证码等全局变量，请使用 Redis 进行状态共享。
3.  **日志清理**：生产环境建议配合 `pm2-logrotate` 插件，防止日志文件撑爆磁盘。
