# 安全性与防御指南 (Security & Protection Guide)

本文档旨在为本自研 SSR 框架提供安全性分析和防御建议，确保在享受高性能渲染的同时，能够抵御常见的 Web 攻击。

## 1. 核心安全防护

### 1.1 XSS (跨站脚本攻击)
*   **JSON 脱水安全**：我们使用 `<script type="application/json">` 来传递 `dehydratedState`。这种方式比直接注入 JS 对象安全得多，因为 `application/json` 类型的脚本不会被浏览器解析执行。
*   **Helmet 注入**：所有通过 `react-helmet-async` 设置的属性（如 `title`, `meta`）在拼接到 HTML 时，应确保这些数据源是可信的或经过转义的。

### 1.2 安全响应头 (Security Headers)
项目已集成 `koa-helmet` 中间件，默认开启以下防护：
*   **CSP (Content Security Policy)**：限制非法资源加载。
*   **X-Frame-Options**: 设为 `SAMEORIGIN`，防止点击劫持。
*   **HSTS**: 强制 HTTPS 访问。
*   **X-Content-Type-Options**: 设为 `nosniff`，防止 MIME 类型混淆攻击。

### 1.3 敏感数据脱水
> [!IMPORTANT]
> **原则**：只发送前端展示所需的数据。
> 1.  在服务端 `prefetch` 拿到数据后，建议进行字段过滤（Pick/Omit）。
> 2.  严禁将包含 `password`, `token`, `internal_id` 等敏感字段的大对象直接扔进 `dehydratedState`。

---

## 2. DDoS 防御与过载保护

SSR 是 CPU 密集型任务，容易受到洪水请求攻击。

### 2.1 基础设施防御
*   **CDN 缓存**：将所有静态资源及具备条件的 HTML 页面托管至 CDN（如 Cloudflare）。
*   **WAF**：在边缘节点配置频率限制，拦截异常 IP。

### 2.2 Nginx 层限流
建议在 Node.js 服务器前部署 Nginx，并配置 `limit_req`：
```nginx
limit_req_zone $binary_remote_addr zone=ssr_limit:10m rate=10r/s;
```

### 2.3 SSR 服务端降级 (关键策略)
当服务器负载过高时，应实施“弃卒保帅”策略：
1.  **检测负载**：监控 Node.js CPU 占用率。
2.  **切换 CSR**：若 CPU > 80%，在 `app/server/index.tsx` 中跳过渲染逻辑，直接返回基础 HTML 模板：
    ```html
    <div id="root"></div>
    ```
    由客户端接管后续渲染，确保服务不宕机。

### 2.4 超时与中止 (Abort)
利用 `renderToPipeableStream` 的 `abort()` 方法。对于渲染超过（如 5s）的请求，强制中止渲染并返回错误或降级页面，释放 CPU 资源。
